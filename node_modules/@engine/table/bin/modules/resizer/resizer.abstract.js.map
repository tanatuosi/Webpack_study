{"version":3,"file":"resizer.abstract.js","sourceRoot":"","sources":["../../../src/modules/resizer/resizer.abstract.ts"],"names":[],"mappings":"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","sourcesContent":["import { SheetOptions } from '@fui/sheet/types';\nimport { expandHtml } from '../table.service';\nimport { CellType, TableStickerOpt } from '../table.types';\nimport { ResizeOption } from './resizer';\nimport { fontScaleAttributeName, resizeStickerExtension } from './resizer.service';\n\nexport interface IAbstractResizerConstructorArgs {\n    minFontSize?: number;\n    [key: string]: any;\n}\n\nexport abstract class AbstractResizer {\n    public isAdaptive = true;\n\n    protected minResizeScale = 0.4;\n    protected minFontSize: number;\n    protected widthResizeScale = 1;\n    protected heightResizeScale = 1;\n\n    abstract resize(data: SheetOptions, opt: ResizeOption): SheetOptions\n\n    public constructor (opts: { minFontSize?: number } = {}) {\n        const { minFontSize = 8 } = opts;\n\n        this.minFontSize = minFontSize;\n    }\n\n    public resizeWidth(cols: number[], width = document.body.clientWidth, rate = 0) {\n        let widthRate = rate;\n\n        cols[cols.length - 1] = 0;\n        cols[cols.length - 2] = 0;\n        cols[0] = 0;\n        // 如果开了自适应，则需要让边距 = 0；\n        const screenWidth = width - 3;\n        const cellCols = [...cols];\n        cellCols.pop();\n        if (!rate) {\n            const sumWidth = cellCols.reduce((total, num) => total + num);\n            widthRate = Math.max(screenWidth / sumWidth, this.minResizeScale);\n        }\n        for (let index = 0; index < cellCols.length; index++) {\n            cols[index] *= widthRate;\n        }\n        // 防止边框和浏览器边框重叠，留1px间距\n        cols[cols.length - 1] = 1;\n        cols[0] = 1;\n    \n        return widthRate;\n    }\n\n    public resizeHeight(rows: number[], height: number, rate = 0) {\n        let heightRate = rate;\n        rows[0] = 0;\n        rows[rows.length - 3] = 0;\n        rows[rows.length - 2] = 0;\n        rows[rows.length - 1] = 0;\n        // 如果开了自适应，则需要让边距 = 0；\n        const cellRows = [...rows];\n        cellRows.pop();\n        if (!rate) {\n            const screenHeight = height - 2;\n            const sumHeight = cellRows.reduce((total, num) => total + num);\n            heightRate = Math.max(screenHeight / sumHeight, this.minResizeScale);\n        }\n        for (let index = 0; index < cellRows.length; index++) {\n            rows[index] *= heightRate;\n        }\n        // 防止边框和浏览器边框重叠，留1px间距\n        rows[rows.length - 1] = 1;\n    \n        return heightRate;\n    }\n\n    protected resizeFont(rate: number, cells?: CellType[][]) {\n        cells && BI.each(cells, (_index: number, item) => {\n            BI.each(item, (_dataIndex: number, data) => {\n                BI.each(BI.get(data, 'items'), (_labelIndex: number, label: any) => {\n                    if (label && label.el && label.el.style) {\n                        // html最小显示12px的文字，但是会随着屏幕缩放而变化，比如缩放到200%，最小就可显示6px\n                        // 而新引擎是用canvas绘制的，而且js无法拿到浏览器缩放比例，所以无法实现和老引擎同样的效果\n                        // 所以目前设置新引擎最小显示8px大小的文字\n                        // 后面看看是否有更加完美的做法\n                        const defaultFontSize = parseInt(label.el.style.defaultFontSize, 10);\n                        const newFontSize = Math.max(defaultFontSize * rate, this.minFontSize);\n                        label.el.style.lineHeight = label.el.style.defaultLineHeight * newFontSize / defaultFontSize;\n                        label.el.style.fontSize = `${newFontSize}px`;\n                    }\n                });\n            });\n        });\n    }\n\n    protected resizeSticker(rate: number, sheet: SheetOptions['sheet']) {\n        (sheet.stickers || []).forEach((sticker: TableStickerOpt) => {\n            sticker.el = sticker.extension ? this.expandHtml(resizeStickerExtension(rate, sticker.extension).el, sticker.extension.style, rate).el : sticker.el;\n        });\n    }\n\n    protected expandHtml(el: string, style: NonNullable<TableStickerOpt['extension']>['style'], fontScale: number) {\n        return BI.isNotNull(style)\n            ? expandHtml(el, {\n                ...style,\n                lineHeight: style.lineHeight * fontScale,\n                paddingLeft: style.paddingLeft * this.widthResizeScale,\n                paddingRight: style.paddingRight * this.widthResizeScale,\n                spacingAfter: style.spacingAfter * this.heightResizeScale,\n                spacingBefore: style.spacingBefore * this.heightResizeScale,\n            }, fontScale)\n            : { el, style, initial: el };\n    }\n\n    /**\n     * 通过font-scale属性进行字体自适应\n     * @param element 父级元素\n     */\n    public resizeFontByFontScaleAttr(element: any) {\n        Array.from(element.find(`*[${fontScaleAttributeName}]`))\n            .forEach((el: HTMLElement) => {\n                const fontSize = window.getComputedStyle(el, null).getPropertyValue('font-size');\n\n                const fontScale = el.getAttribute(fontScaleAttributeName);\n\n                el.style.fontSize = `calc(${fontScale} * ${fontSize})`;\n            });\n    }\n}\n"]}