{"version":3,"file":"target.dialog.js","sourceRoot":"","sources":["../../../../src/modules/links/target/target.dialog.ts"],"names":[],"mappings":"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","sourcesContent":["import { findTargetParent } from '@engine/core';\nimport { openUrlByPost } from '@engine/crud';\nimport { ReportPopover } from '@engine/utils';\nimport { remoteEvaluate } from '../../hyper_link.crud';\nimport { AbstractTarget } from './target.abstract';\n\nexport class DialogTarget extends AbstractTarget {\n    private options: DialogTargetOp;\n\n    private popover: ReportPopover;\n\n    public constructor(target: string, url: string, op: DialogTargetOp) {\n        super(target, url, op);\n\n        this.options = op;\n    }\n\n    public handle() {\n        const { width = 0, height = 0, attr = {}, byPost, parameter } = this.options;\n\n        const { title, ...position } = attr;\n\n        const dialogID = BI.UUID();\n        this.getHeader(title)\n            .then(header => {\n                const targetName = BI.UUID(); // REPORT-26824 targetName取随机字符串，否则post请求第二次点开时显示空白\n\n                const parent = this.findTargetParent();\n        \n                parent.BI.Popovers.create(dialogID, {\n                    type: ReportPopover.xtype,\n                    width: Math.min(width, window.innerWidth),\n                    height: Math.min(height, window.innerHeight),\n                    header,\n                    ref: (_ref: ReportPopover) => {\n                        this.popover = _ref;\n                    },\n                    body: {\n                        type: BI.AbsoluteLayout.xtype,\n                        items: [\n                            {\n                                el: {\n                                    type: BI.Iframe.xtype,\n                                    src: byPost ? '' : this.url,\n                                    name: targetName,\n                                },\n                                top: 0,\n                                left: 0,\n                                right: 0,\n                                bottom: 0,\n                            },\n                        ],\n                    },\n                    listeners: [\n                        {\n                            eventName: BI.Popover.EVENT_CLOSE,\n                            action: () => {\n                                BI.Popovers.remove(dialogID);\n                            },\n                        },\n                    ],\n                }).open(dialogID);\n\n                BI.isNotEmptyObject(position) && this.popover.setPosition(position);\n                \n                if (byPost) {\n                    openUrlByPost(this.url, { __parameters__: parameter }, targetName);\n                }\n            });\n\n        return dialogID;\n    }\n\n    private findTargetParent(): $Window {\n        return findTargetParent(parent => !!(parent.Report && parent.BI));\n    }\n\n    private async getHeader(title: string | TitleType | undefined) {\n        if (BI.isObject(title)) {\n            const res = await remoteEvaluate((<TitleType>title).value);\n\n            return res?.result;\n        }\n\n        return title;\n    }\n}\n\ninterface DialogTargetOp {\n    width?: number;\n    height?: number;\n    attr?: {\n        center?: boolean;\n        top?: number;\n        left?: number;\n        title?: string | TitleType;\n    };\n    byPost?: boolean;\n    parameter?: string;\n}\n\ninterface TitleType {\n    type: string,\n    value: string,\n}\n"]}