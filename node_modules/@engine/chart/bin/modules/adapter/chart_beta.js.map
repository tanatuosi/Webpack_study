{"version":3,"file":"chart_beta.js","sourceRoot":"","sources":["../../../src/modules/adapter/chart_beta.ts"],"names":[],"mappings":"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","sourcesContent":["import { errorTip, shortcut } from '@engine/core';\nimport { AbstractLink, HyperLinkClickHandler, instantiateXHyperLinks, XHyperLink } from '@engine/link';\nimport { fetchChartHyperLinks } from '../chart.crud';\nimport { chartManager } from '../chart.manager';\nimport { AbstractReportChart } from './chart.abstract';\n\n@shortcut()\nexport class ReportChartBeta extends AbstractReportChart {\n    public static xtype = 'report.chart_beta';\n\n    public static VERSION = '1.0.0';\n\n    public static BUILD_TIME = '2020-8-31 09:27:02';\n\n    private hyperlinkHandler = new HyperLinkClickHandler(widget => {\n        BI.createWidget({\n            ...widget,\n            element: this,\n        });\n    });\n\n    public props = {\n        chartAttrGetter: async () => <any>{},\n        autoSize: true, // 图表是否根据容器大小自动设置尺寸，如果是false，则手动传入width和height。\n        instantiateXHyperLinks: (javaScriptGroup: XHyperLink[]) => instantiateXHyperLinks(javaScriptGroup),\n        wScale: 1,\n        hScale: 1,\n        fontScale: 1,\n        chartHyperLinkId: '',\n    }\n\n    @errorTip()\n    public render() {\n        VanCharts.resetGlobalScale(this.options.fontScale);\n\n        return {\n            type: BI.AbsoluteLayout.xtype,\n        };\n    }\n    \n    public mounted() {\n        this.getChartAttr().then(chartAttr => {\n            if ('errorCode' in chartAttr) {\n                this.fireEvent('EVENT_SHOW_ERROR', chartAttr);\n\n                throw {\n                    errorCode: chartAttr.errorCode,\n                    errorMsg: chartAttr.errorMsg,\n                };\n            }\n\n            this.chartAttr = chartAttr;\n\n            const chart = chartManager.getWidgetByName(this.chartAttr.chartID);\n            chart && chart.remove();\n            this.initChart();\n            this.fireEvent(AbstractReportChart.EVENT_LOADED);\n        });\n    }\n\n    public refresh() {\n        const { wScale, hScale, fontScale } = this.options;\n\n        this.resize(wScale, hScale, fontScale);\n    }\n\n    public async reload(attr?: any) {\n        this.chartAttr = attr ? attr : await this.getChartAttr();\n        this.initChart();\n    }\n\n    /**\n     * 修改图表参数，用于联动\n     * @param params 参数\n     */\n    public changeParameter(params: { [key: string]: any }) {\n        this.chart.changeParameter(params);\n    }\n\n    public resize(_wScale: number, _hScale: number, fontScale: number) {\n        this.options.fontScale = fontScale;\n\n        VanCharts.resetGlobalScale(fontScale);\n\n        this.chart?.resize();\n    }\n\n    private initChart() {\n        this.remove();\n        this.enforceChartAttr();\n        this.chart = new VanChartWidget(this.chartAttr, this.element);\n        chartManager.register(this, this.chartAttr.chartID);\n    }\n\n    protected enforceChartAttr() {\n        const { fontScale } = this.options;\n\n        if (this.chartAttr?.chartAttr) {\n            this.chartAttr.chartAttr.scale = fontScale;\n            \n            // FIXME: 图表那边手动设置width和height还有点问题，先注释掉\n            // if (!this.options.autoSize) {\n            //     this.chartAttr.chartAttr.width = this.chartAttr.width;\n            //     this.chartAttr.chartAttr.height = this.chartAttr.height;\n            // }\n        }\n    }\n\n    public remove() {\n        this.removeChart();\n\n        this.chartAttr && chartManager.getWidgetsMap().delete(this.chartAttr.chartID);\n    }\n\n    public destroy() {\n        this.remove();\n    }\n\n    protected removeChart() {\n        if (this.chart && this.chart.chartWrapper) {\n            this.chart.chartWrapper.clearAll();\n            this.chart.options = this.chart.chartWrapper = null;\n        }\n    }\n\n    private async getChartAttr() {\n        const chartAttr = await this.options.chartAttrGetter();\n        \n        return {\n            ...chartAttr,\n            doFineHyperlink: (e: Event, params: any, filter: <T>(arr: T[]) => T[] = arr => arr) => {\n                let hyperLinks: AbstractLink[] = [];\n                !params.ChartHyperlink_ID && (params.ChartHyperlink_ID = this.options.chartHyperLinkId);\n                \n                fetchChartHyperLinks(params)\n                    .then(result => {\n                        const javaScriptGroup = filter(result.nxNameJavascriptGroup?.javaScriptGroup || []);\n                        \n                        hyperLinks = this.options.instantiateXHyperLinks(javaScriptGroup);\n\n                        this.hyperlinkHandler.handle(e, hyperLinks);\n                    });\n            },\n        };\n    }\n}\n"]}