{"version":3,"file":"sync_tree.js","sourceRoot":"","sources":["../../../../../src/modules/tree_like/tree/sync_tree/sync_tree.ts"],"names":[],"mappings":";;;;;;AACA,OAAO,EAAE,QAAQ,EAAE,MAAM,cAAc,CAAC;AACxC,OAAO,EAAE,cAAc,EAAE,wBAAwB,EAAE,MAAM,iBAAiB,CAAC;AAG3E,IAAa,QAAQ,GAArB,MAAa,QAAS,SAAQ,EAAE,CAAC,wBAAwB;IAAzD;;QAKY,iBAAY,GAAG,IAAI,CAAC;QAIrB,UAAK,GAAG;YACX,OAAO,EAAE,4BAA4B;YACrC,KAAK,EAAE,IAAI;YACX,YAAY,EAAE,EAAE,CAAC,OAAO;YACxB,KAAK,EAAE,SAA+B;SACzC,CAAA;IAgGL,CAAC;IA5FU,KAAK;QACR,KAAK,CAAC,KAAK,CAAC,KAAK,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;QACnC,IAAI,CAAC,IAAI,GAAG,EAAE,CAAC,YAAY,CAAC;YACxB,IAAI,EAAE,EAAE,CAAC,SAAS,CAAC,KAAK;YACxB,OAAO,EAAE,IAAI;YACb,YAAY,EAAE,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE,IAAI,CAAC;SAClD,CAAC,CAAC;QAEH,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,CAAC,eAAe,CAAC,YAAY,EAAE,GAAG,EAAE;YAC/C,IAAI,CAAC,SAAS,CAAC,cAAc,CAAC,CAAC;QACnC,CAAC,CAAC,CAAC;IACP,CAAC;IAEM,gBAAgB,CAAC,CAAM;QAC1B,IAAI,CAAC,OAAO,CAAC,KAAK,GAAG,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC;QAEzC,IAAI,CAAC,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,IAAI,EAAE,CAAC,CAAC;IACzD,CAAC;IAEM,QAAQ,CAAC,CAAM;QAClB,IAAI,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC;IAC7B,CAAC;IAEM,QAAQ;QACX,OAAO,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC;IAChC,CAAC;IAED;;OAEG;IACI,gBAAgB;QACnB,OAAO,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC,CAAC;IAClD,CAAC;IAEM,QAAQ;QACX,MAAM,CAAC,GAAG,IAAI,CAAC,OAAO,CAAC;QAEvB,CAAC,CAAC,YAAY,CAAC,EAAE,EAAE,CAAC,CAAM,EAAE,EAAE;YAC1B,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC;YACxB,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC,KAAK,CAAC;YAC1B,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC;YACvB,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC;YAErB,IAAI,CAAC,0BAA0B,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;QACvD,CAAC,CAAC,CAAC;IACP,CAAC;IAEM,gBAAgB;QACnB,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;IAC7B,CAAC;IAED;;;OAGG;IACI,0BAA0B,CAAC,UAA0B;QACxD,UAAU,CAAC,GAAG,EAAE;YACZ,MAAM,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC;YAE7B,MAAM,MAAM,GAAG,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC;YAEnC,MAAM,KAAK,GAAG,UAAU,KAAK,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC,CAAC,CAAC,UAAU,aAAV,UAAU,uBAAV,UAAU,CAAE,QAAQ,CAAC;YAE3E,KAAK,IAAI,KAAK,CAAC,OAAO,CAAC,CAAC,IAAS,EAAE,EAAE;gBACjC,MAAM,SAAS,GAAG,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,QAAQ,CAAC,EAAE,KAAK,IAAI,CAAC,EAAE,CAAC,CAAC;gBAE5E,IAAI,CAAC,SAAS,IAAI,CAAC,CAAC,CAAA,SAAS,aAAT,SAAS,uBAAT,SAAS,CAAE,IAAI,KAAI,IAAI,CAAC,OAAO,CAAC,EAAE;oBAClD,OAAO;iBACV;gBAED,IAAI,CAAC,UAAU,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;gBAE9B,IAAI,CAAC,0BAA0B,CAAC,IAAI,CAAC,CAAC;YAC1C,CAAC,CAAC,CAAC;QACP,CAAC,EAAE,EAAE,CAAC,CAAC;IACX,CAAC;IAEO,UAAU,CAAC,MAAc,EAAE,IAAS;QACxC,IAAI,CAAC,IAAI,CAAC,iBAAiB,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;IAC9C,CAAC;IAED;;;OAGG;IACK,WAAW,CAAC,KAAc;;QAC9B,IAAI,CAAC,KAAK,IAAI,EAAE,CAAC,aAAa,CAAC,KAAK,CAAC,EAAE;YACnC,OAAO,KAAK,CAAC;SAChB;QAED,OAAO,cAAc,CAAC,KAAK,EAAE,wBAAwB,CAAC,MAAA,IAAI,CAAC,IAAI,0CAAE,MAAM,EAAE,CAAC,CAAC,CAAC;IAChF,CAAC;CACJ,CAAA;AA7GiB,cAAK,GAAG,sDAAsD,CAAC;AADpE,QAAQ;IADpB,QAAQ,EAAE;GACE,QAAQ,CA8GpB;SA9GY,QAAQ","sourcesContent":["import { AsyncTree } from '@fui/core';\nimport { shortcut } from '@engine/core';\nimport { mergeTreeValue, transformTreeNodesToJson } from '../tree.service';\n\n@shortcut()\nexport class SyncTree extends BI.AbstractTreeValueChooser {\n    public static xtype = 'report.main.parameter_container.controller.sync_tree';\n\n    private pane: AsyncTree;\n\n    private isAutoExpand = true;\n\n    private tree: any;\n\n    public props = {\n        baseCls: 'bi-tree-value-chooser-pane',\n        items: null,\n        itemsCreator: BI.emptyFn,\n        value: undefined as KeyMap | undefined,\n    }\n\n    private nodesItems: any[];\n\n    public _init() {\n        super._init.apply(this, arguments);\n        this.pane = BI.createWidget({\n            type: BI.AsyncTree.xtype,\n            element: this,\n            itemsCreator: BI.bind(this._itemsCreator, this),\n        });\n\n        this.pane.on(BI.MultiSelectTree.EVENT_CHANGE, () => {\n            this.fireEvent('EVENT_CHANGE');\n        });\n    }\n\n    public setSelectedValue(v: any) {\n        this.options.value = this.mergeValues(v);\n\n        this.pane.setSelectedValue(this.options.value || {});\n    }\n\n    public setValue(v: any) {\n        this.setSelectedValue(v);\n    }\n\n    public getValue () {\n        return this.pane.getValue();\n    }\n\n    /**\n     * 公开接口，获取已选值，全选的值会被合并\n     */\n    public getSelectedValue () {\n        return this.mergeValues(this.pane.getValue());\n    }\n\n    public populate() {\n        const o = this.options;\n\n        o.itemsCreator({}, (v: any) => {\n            this._initData(v.items);\n            this.nodesItems = v.items;\n            this.setValue(o.value);\n            this.pane.populate();\n\n            this.expandSelectedChildrenNode(this.isAutoExpand);\n        });\n    }\n\n    public enableAutoExpand() {\n        this.isAutoExpand = true;\n    }\n\n    /**\n     * 是否自动展开节点\n     * @param parentNode 如果是根节点传true，不然传父节点\n     */\n    public expandSelectedChildrenNode(parentNode?: any | boolean) {\n        setTimeout(() => {\n            const tree = this.pane.nodes;\n\n            const treeId = tree.setting.treeId;\n\n            const nodes = parentNode === true ? tree.getNodes() : parentNode?.children;\n\n            nodes && nodes.forEach((node: any) => {\n                const foundNode = this.nodesItems.find(nodeitem => nodeitem.id === node.id);\n\n                if (!foundNode || !(foundNode?.open || node.checked)) {\n                    return;\n                }\n    \n                this.expandNode(treeId, node);\n                \n                this.expandSelectedChildrenNode(node);\n            });\n        }, 17);\n    }\n    \n    private expandNode(treeId: string, node: any) {\n        this.pane._beforeExpandNode(treeId, node);\n    }\n\n    /**\n     * 同步树节点，手动合并下值\n     * @param value 值\n     */\n    private mergeValues(value?: KeyMap): KeyMap | undefined {\n        if (!value || BI.isEmptyObject(value)) {\n            return value;\n        }\n\n        return mergeTreeValue(value, transformTreeNodesToJson(this.tree?.toJSON()));\n    }\n}\n\ninterface KeyMap {\n    [key: string]: KeyMap\n}\n"]}